<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>پنل مدیریت سهام - <%= team.name %></title>
    <meta id="ti" content="<%= team._id %>">  
    <link rel="shortcut icon" href="/nasiri-logo.ico">
    <script src="/js/jquery-3.3.1.min.js"></script>
    <script src="/js/popper.min.js"></script>
    <script src="/js/bootstrap.js"></script>
    <script src="/js/bootstrap.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="/css/bootstrap.min.rtl.css">
    <link rel="stylesheet" href="/font-awsome/css/font-awesome.css">
    <link rel="stylesheet" href="/css/styles.css">?
    <style>
        body {
            background: linear-gradient(135deg, #1a2a6c, #2c3e50);
            color: #fff;
            font-family: 'Vazirmatn', sans-serif;
            min-height: 100vh;
        }
        
        .dashboard-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .company-header {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .status-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
        }
        
        .status-healthy { background-color: #2ecc71; }
        .status-warning { background-color: #f39c12; }
        .status-danger { background-color: #e74c3c; }
        .status-bankrupt { background-color: #8e44ad; }
        
        .stock-price {
            font-size: 2.5rem;
            font-weight: bold;
            margin: 15px 0;
        }
        
        .price-change {
            font-size: 1.2rem;
            margin-right: 10px;
        }
        
        .price-up { color: #2ecc71; }
        .price-down { color: #e74c3c; }
        
        .inventory-card, .profit-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .transaction-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .transaction-item {
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
        }
        
        .transaction-item:last-child {
            border-bottom: none;
        }
        
        #gotostocks:hover{
            background-color: whitesmoke;
            color: black;
        }

        .buy-transaction { border-right: 5px solid #2ecc71; }
        .sell-transaction { border-right: 5px solid #e74c3c; }
        .event-transaction { border-right: 5px solid #3498db; }
        
        .chart-container {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            height: auto;
        }
        
        .control-panel {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .control-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .profit-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }
        
        .profit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
        }
        
        .loss-btn {
            background: linear-gradient(45deg, #c0392b, #e74c3c);
            color: white;
        }
        
        .loss-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
        }
        
        .bankruptcy-btn {
            background: linear-gradient(45deg, #8e44ad, #9b59b6);
            color: white;
        }
        
        .bankruptcy-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }
        
        .bankruptcy-alert {
            background: rgba(142, 68, 173, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            text-align: center;
            display: none;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .update-timer {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 15px;
            border-radius: 30px;
            font-size: 0.9rem;
            display: none;
        }
        
        .shimmer {
            background: linear-gradient(90deg, rgba(255,255,255,0) 0%, rgba(255,255,255,0.2) 50%, rgba(255,255,255,0) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .legend-color {
            width: 20px;
            height: 3px;
            border-radius: 2px;
        }
        .price {
            font-weight: 700;
            font-size: 18px;
            color: #38a169;
        }
        .item-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 17px;
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- هدر شرکت -->
        <div class="company-header text-center">
            <h1><i class="fa fa-building"></i> شرکت <%= team.name %></h1>
            <p class="mb-0">پنل مدیریت سهام - سهامدار: <span id="shareholderName"><strong><%= user.username %></strong></span></p>
            <div class="mt-2">
                <span>وضعیت شرکت: </span>
                <span id="companyStatus" class="fw-bold">سالم</span>
                <span id="statusIndicator" class="status-indicator status-healthy"></span>
            </div>
        </div>
        
        <div class="row">
            <!-- کارت قیمت سهام -->
            <div class="col-lg-6 mb-4">
                <div class="status-card">
                    <h3><i class="fa fa-chart-line"></i> قیمت سهام ها</h3>
                    <table id="stocks" border="3px" dir="rtl" style="background-color: whitesmoke;width: 100%;">
                        <thead style="color: black;">
                            <tr>
                                <th style="width: 50px;">نام سهام</th>
                                <th style="width: 90px;">قیمت فعلی</th>
                                <th style="width: 90px;">قیمت قبلی</th>
                                <th style="width: 20px;">درصد تغیرات</th>
                            </tr>
                        </thead>
                        <tbody id="table-body">
                            <% for(let i = 0;i < stocks.length;i++) { %>
                                <tr style="background-color: <% ((i % 2 == 0) ? 'grey' : 'whitesmoke') %>;padding: 8px;"><td class="item-name" style="padding: 8px;"><%= stocks[i].name %></td><td class="price" style="padding: 8px;"><%= stocks[i].price.toLocaleString() %></td><td class="price" style="padding: 8px;"><%= stocks[i].priceHistory[stocks[i].priceHistory.length-1].toLocaleString() %></td><td style="padding: 8px;color: black;color: <%= (stocks[i].price >= stocks[i].priceHistory[stocks[i].priceHistory.length - 1]) ? 'Green' : 'Red' %>;"><strong><%= (((stocks[i].price - stocks[i].priceHistory[stocks[i].priceHistory.length - 1])/(stocks[i].priceHistory[stocks[i].priceHistory.length - 1]))*100).toFixed(2) %>%</strong></td></tr>

                            <% } %>
                        </tbody>
                    </table>
                    <div>
                        <span id="lastUpdate">آخرین به‌روزرسانی: هم اکنون</span>
                        <br><br><br>
                        <a href="/stocks" id="gotostocks" style="color: grey;border: 1px solid white;padding: 8px;border-radius: 5px;transition: 1s;">
                            خرید و فروش
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- کارت موجودی کالا -->
            <div class="col-lg-6 mb-4">
                <div class="inventory-card">
                    <h3><i class="fa fa-boxes"></i> موجودی کالا</h3>
                    <div class="d-flex justify-content-between align-items-center">
                        <table border="3px" style="background-color: whitesmoke;width: 100%;">
                            <tr style="color: black;"><th style="width: 50px;">نام سهام</th><th style="width: 90px;">قیمت سهام</th><th style="width: 90px;">تعداد نگهداری شده</th></tr>
                        <% for(let i = 0;i < team_stocks.length;i++) { %>
                            <% if(team_stocks[i].quantity != 0) { %>
                                <tr><td class="item-name" style="padding: 8px;"><%= ts_names[i] %></td><td class="price" style="padding: 8px;"><%= ts_prices[i].toLocaleString() %></td><td style="padding: 8px;color: black;"><strong><%= team_stocks[i].quantity.toLocaleString() %></strong></td></tr>
                            <% } %>
                        <% } %>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <!-- کارت سود سهام -->
            <div class="col-lg-6 mb-4">
                <div class="profit-card">
                    <h3><i class="fa fa-wallet"></i> سود سهام شما</h3>
                    <div class="">
                        <strong><div class="fs-2" id="totalProfit">ارزش خزانه: <%= team.net_worth.toLocaleString() %></div></strong>
                        <div class="mt-2">
                            <span>تعداد سهام: </span>
                            <span id="shareCount"><%= tsq %> سهام</span>
                        </div>
                        <div class="mt-2">
                            <span>
                                ارزش در سهام: 
                            </span>
                            <span>
                                <%= net_value.toLocaleString() %>
                            </span>
                        </div>
                        <div class="mt-1">
                            <span>ارزش فعلی: </span>
                            <span id="shareValue"><%= (net_value + team.net_worth).toLocaleString() %></span>
                        </div>
                    </div>
                    <div class="">
                        <div class="mt-1">
                            <span>
                                سود شرکت: 
                            </span>
                            <span style="color: <%= (profit >= 0) ? 'rgb(70, 175, 70)':'red' %>;" id="profit_goes_here">
                                <%= profit.toFixed(2) %>%
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- کارت تراکنش‌ها -->
            <div class="col-lg-6 mb-4">
                <div class="status-card">
                    <h3><i class="fa fa-exchange-alt"></i> آخرین تراکنش‌ها</h3>
                    <div class="transaction-log" id="transactionLog">
                        <% for(let i = 0;i < transactions.length;i++) { %>
                            <% if(transactions[i].operation == "buy") { %>
                                <div class="transaction-item buy-transaction">
                                    <span>
                                        <%= (transactions[i].operation == "buy") ? "خرید" : "فروش" %> <%= transactions[i].number %> واحد <%= trs_names[i] %> توسط <%= (trs_users[i].username == user.username) ? 'شما' : trs_users[i].username %> به قیمت <%= transactions[i].stock_price.toLocaleString() %>
                                    </span>
                                </div>
                            <% } else { %>
                                <div class="transaction-item sell-transaction">
                                    <span>
                                        <%= (transactions[i].operation == "buy") ? "خرید" : "فروش" %> <%= transactions[i].number %> واحد <%= trs_names[i] %>  توسط <%= (trs_users[i].username == user.username) ? 'شما' : trs_users[i].username %> به قیمت <%= transactions[i].stock_price.toLocaleString() %>
                                    </span>
                                </div>
                            <% } %>
                        <% } %>
                    </div>
                </div>
            </div>
            <% if(finalee == "yes") { %>
                <div class="col-lg-12 status-card" style="background: rgba(255, 255, 255, 0.1);color: black;">
                <div class="col-lg-6">
                    <h2 style="text-align: center;">
                        ارسال درخواست
                    </h2>
                    <br>
                    <select name="to_team" id="to_team" class="form-control">
                        <% for(let i = 0; i < teams.length;i++) { %>
                            <% if(String(team._id) != String(teams[i]._id)) { %>
                                <option value="<%= teams[i]._id %>"><%= teams[i].name %></option>
                            <% } %>
                        <% } %>
                    </select>
                    <br>
                    <div class="col-lg-6">
                        <label for="buy_stock">خرید</label> <input type="radio" name="bos" id="b">
                    </div>
                    <div class="col-lg-6">
                        <label for="sell_stock">فروش</label> <input type="radio" name="bos" id="s">
                    </div>
                    <br>
                    <div id="buy_sec">
                        <div class="col-lg-8">
                        <select name="stock_id" id="stock_id" class="form-control">
                            <% for(let i = 0;i < stocks.length;i++) { %>
                                <option value="<%= stocks[i]._id %>"><%= stocks[i].name %></option>
                            <% } %>
                        </select>
                        </div>
                        <div class="col-lg-4">
                            <input type="text" placeholder="تعداد خرید" name="quantity" id="quantity_of_stock" class="form-control" style="border-radius: 50px;" value="0">
                        </div>
                        <br><br><br>
                        <div class="col-lg-4">
                            <select name="payment_method" id="payment_method" class="form-control">
                                <option value="stocks">
                                    با سهام
                                </option>
                                <option value="money">
                                    با پول
                                </option>
                            </select>
                        </div>
                        <div class="col-lg-4" id="what_stock">
                            <select name="with_this_stock" id="with_this_stock" class="form-control">
                                <% for(let i = 0;i < stocks.length;i++) { %>
                                    <option value="<%= stocks[i]._id %>"><%= stocks[i].name %></option>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-lg-4">
                            <input type="text" class="form-control" style="border-radius: 50px;" name="payment_quantity" id="payment_quantity" placeholder="تعداد پرداخت" value="0">
                        </div>
                        <br><br><br>
                        <button class="btn btn-primary col-lg-2 col-lg-push-5" type="button" id="buy_it"> 
                            <div class="fa fa-plus">

                            </div>
                        </button>
                    </div>
                    <div id="sell_sec" style="display: none;">
                        <div class="col-lg-8">
                            <select name="sells_what" id="sells_what" class="form-control">
                                <% for(let i = 0;i < stocks.length;i++) { %>
                                    <option value="<%= stocks[i]._id %>"><%= stocks[i].name %></option>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-lg-4">
                            <input type="text" value="0" class="form-control" autocomplete="off" name="how_many_sells" id="how_many_sells" style="border-radius: 50px;">
                        </div>
                        <br><br><br>
                        <div class="col-lg-4">
                            <select name="sells_by" id="sells_by" class="form-control">
                                <option value="stock">دریافت سهام</option>
                                <option value="money">دریافت پول</option>
                            </select>
                        </div>
                        <div class="col-lg-4">
                            <select name="gets_stock" id="gets_stock" class="form-control">
                                <% for(let i = 0;i < stocks.length;i++) { %>
                                    <option value="<%= stocks[i]._id %>"><%= stocks[i].name %></option>
                                <% } %>
                            </select>
                        </div>
                        <div class="col-lg-4">
                            <input type="text" class="form-control" autocomplete="off" name="gets_how_many" id="gets_how_many" value="0" style="border-radius: 50px;">
                        </div>
                        <br><br><br>
                        <button type="button" name="sells" id="sells" class="btn btn-primary col-lg-2 col-lg-push-5">
                            <div class="fa fa-minus">

                            </div>
                        </button>
                    </div>
                </div>
                <div class="col-lg-6">
                    <h2 style="text-align: center;">
                        درخواست های ما به...
                    </h2>
                    <br><br><br>
                    <% for(let i = 0;i < sent["team"].length;i++) { %>
                        <div class="col-lg-12">
                            <div class="col-lg-2" style="background-color: green;height: 10px;">

                            </div>
                            <div class="col-lg-10" style="height: 10px;">
                                <div class="row">
                                    <div class="col-lg-3">
                                    درخواست به تیم: <%= sent["team"][i].name %>
                                    </div>
                                    <div class="col-lg-7">
                                        <% if(sent["bs"][i] == "buy") { %>  
                                        درخواست: خرید <%= sent["stock"][i].name %> به تعداد <%= sent["bs_howmany"][i].toLocaleString() %>
                                    <% }else { %>
                                        درخواست: فروش <%= sent["stock"][i].name %> به تعداد <%= sent["bs_howmany"][i].toLocaleString() %>
                                    <% } %>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-4">
                                        نحوه پرداخت: <%= (sent["pays_buy"][i] == "money") ? sent["pays_buy"][i] : sent["pays_buy"][i].name %>
                                    </div>
                                    <div class="co-lg-6">
                                        تعداد: <%= sent["pays_how_m"][i].toLocaleString() %>
                                    </div>
                                    <div class="col-lg-2">
                                        وضعیت: <%= (sent["state"][i]) ? "قبول شده" : "در حال بررسی" %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <br><br><br><br><br><br><br>
                    <% } %>
                    <br><br>
                    <div class="col-lg-12" style="border: 1px solid black;">

                    </div>
                    <br><br>
                    <% for(let i = 0;i < recived["team"].length;i++) { %>
                        <div class="col-lg-12">
                            <div class="col-lg-2" style="background-color: crimson;height: 10px;">

                            </div>
                            <div class="col-lg-10" style="height: 10px;">
                                <div class="row">
                                    <div class="col-lg-3">
                                    درخواست از تیم: <%= recived["team"][i].name %>
                                    </div>
                                    <div class="col-lg-7">
                                        <% if(recived["bs"][i] == "buy") { %>  
                                        درخواست: خرید <%= recived["stock"][i].name %> به تعداد <%= recived["bs_howmany"][i].toLocaleString() %>
                                    <% }else { %>
                                        درخواست: فروش <%= recived["stock"][i].name %> به تعداد <%= recived["bs_howmany"][i].toLocaleString() %>
                                    <% } %>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-3">
                                        نحوه پرداخت: <%= (recived["pays_buy"][i] == "money") ? recived["pays_buy"][i] : recived["pays_buy"][i].name %>
                                    </div>
                                    <div class="co-lg-3">
                                        تعداد: <%= recived["pays_how_m"][i].toLocaleString() %>
                                    </div>
                                    <div class="col-lg-2">
                                        وضعیت: <%= (recived["state"][i]) ? "قبول شده" : "در حال بررسی" %>
                                    </div>
                                    <% if(!recived['state'][i]) { %>
                                        <button type="button" class="col-lg-3 btn btn-success accept_o" id="<%= recived['offer_id'][i] %>" style="text-align: center;">
                                            قبول درخواست
                                        </button>
                                        <button type="button" class="col-lg-1 btn btn-danger decline_o" id="<%= recived['offer_id'][i] %>" style="text-align: center;"> 
                                            رد
                                        </button>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        <br><br><br><br><br><br><br><br>
                    <% } %>
                    
                    
                </div>
            </div>
            <% } %>
        </div>
        
        <!-- نمودار تغییرات -->
        
    
    
    
    <script src="/js/client.js"></script>
</body>
</html>